<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Olahraga Sehat — Aktivitas & Peta</title>

<!-- Leaflet Map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  :root{
    --bg1:#0b0f1f; --bg2:#0a0d19; --card:#131a2c; --muted:#93a1bd;
    --text:#e8eefc; --p1:#2dd4bf; --p2:#7c3aed; --p3:#22d3ee; --p4:#6366f1;
    --ok:#10b981; --err:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;
    background: radial-gradient(1200px 600px at 80% -10%, #263169 0%, transparent 60%),
                linear-gradient(160deg, var(--bg1), var(--bg2));
    overflow-x:hidden;
  }
  /* --- Animated background blobs for login --- */
  .bg-anim::before,.bg-anim::after{
    content:""; position:fixed; inset:auto; width:60vmax; height:60vmax; border-radius:50%;
    filter: blur(60px); opacity:.35; z-index:-1; animation: float 18s ease-in-out infinite;
    background: radial-gradient(circle at 30% 30%, #5b7cfa, transparent 55%),
                radial-gradient(circle at 70% 70%, #2dd4bf, transparent 55%);
  }
  .bg-anim::after{ left:auto; right:-10vmax; bottom:-10vmax; animation-delay:-9s;
    background: radial-gradient(circle at 30% 70%, #7c3aed, transparent 55%),
                radial-gradient(circle at 70% 30%, #22d3ee, transparent 55%); }
  @keyframes float{
    0%,100%{ transform: translate(-5%,0) scale(1);}
    50%{ transform: translate(8%,-4%) scale(1.05);}
  }

  .wrap{max-width:980px;margin:0 auto;padding:24px}
  header{
    position:sticky;top:0;z-index:5;
    background:linear-gradient(180deg, rgba(10,12,24,.95), rgba(10,12,24,.55) 80%, transparent);
    backdrop-filter:saturate(120%) blur(8px); padding:10px 16px 6px; margin:-10px -16px 16px;
  }
  .brand{display:flex;align-items:center;gap:10px}
  .logo-mini{
    width:36px;height:36px;border-radius:12px;display:grid;place-items:center;font-weight:900;
    color:#0b0e19; box-shadow:0 8px 30px rgba(99,102,241,.35);
    background: linear-gradient(135deg,var(--p1),var(--p4));
  }
  nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .tab{
    border:1px solid #222742;background:#0f1424;padding:8px 12px;border-radius:12px;
    color:#cbd5e1;text-decoration:none;font-weight:600
  }
  .tab.active{background:linear-gradient(135deg,var(--p1),var(--p4)); color:#0b0e19}
  .grid{display:grid;gap:16px}
  @media(min-width:800px){.grid{grid-template-columns:1fr 1fr}}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    border:1px solid #1e243c; border-radius:18px; padding:16px; box-shadow:0 8px 40px rgba(0,0,0,.25)
  }
  .title{font-size:20px;font-weight:800;margin:0 0 6px}
  .muted{color:var(--muted);font-size:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{border:0;padding:12px 14px;border-radius:14px;font-weight:700;cursor:pointer}
  .btn.primary{background:linear-gradient(135deg,var(--p1),var(--p4)); color:#0b0e19}
  .btn.ghost{background:#12172a;border:1px solid #263055;color:#dbe7ff}
  .btn.danger{background:#2a0f14;border:1px solid #5a1a22;color:#fecaca}
  .pill{padding:6px 10px;border-radius:999px;background:#0f162b;border:1px solid #213055;font-size:12px}
  .stat{display:grid;grid-template-columns:auto 1fr;gap:8px 14px;font-weight:700}
  #map{width:100%;height:340px;border-radius:16px;border:1px solid #1e243c}
  table{width:100%;border-collapse:collapse}
  td,th{padding:10px;border-bottom:1px solid #1f2540;font-size:14px}
  tr:hover{background:#0f1424}
  .right{text-align:right}

  /* ---- LOGIN SCREEN ---- */
  .login{
    position:fixed; inset:0; display:grid; place-items:center; padding:28px; z-index:20;
    background: radial-gradient(1200px 600px at 80% -10%, rgba(38,49,105,.6) 0%, transparent 60%),
                linear-gradient(160deg, #0a0d19, #0b0f1f);
  }
  .panel{
    width:min(560px,90vw); text-align:center; padding:28px; border-radius:22px;
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    border:1px solid #263055; box-shadow:0 20px 60px rgba(0,0,0,.45);
    animation: fadeIn .8s ease both;
  }
  @keyframes fadeIn{ from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:none}}
  .logo-S{
    width:120px; height:120px; margin:6px auto 10px; border-radius:28px; position:relative;
    display:grid; place-items:center; overflow:hidden;
    box-shadow: 0 10px 40px rgba(124,58,237,.45), inset 0 0 20px rgba(34,211,238,.25);
    background:#0b0f1f;
    animation: pop 1.1s cubic-bezier(.2,.7,.2,1) both;
  }
  @keyframes pop{0%{transform:scale(.8)} 60%{transform:scale(1.08)} 100%{transform:scale(1)}}
  /* animated gradient ring */
  .logo-S::before{
    content:""; position:absolute; inset:-2px; border-radius:30px; padding:2px; 
    background: conic-gradient(from 0deg, var(--p1), var(--p3), var(--p4), var(--p2), var(--p1));
    -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
    -webkit-mask-composite: xor; mask-composite: exclude;
    animation: spin 6s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg)}}
  /* the "S" */
  .s-glyph{
    font-size:64px; font-weight:900; line-height:1; z-index:1;
    background: linear-gradient(135deg, #8be9e0, #b69cff 40%, #56e5ff 80%);
    -webkit-background-clip:text; background-clip:text; color:transparent;
    animation: shine 3.2s ease-in-out infinite;
    text-shadow:0 0 25px rgba(125, 90, 255, .35);
  }
  @keyframes shine{
    0%,100%{ filter:drop-shadow(0 0 10px rgba(45,212,191,.4))}
    50%{ filter:drop-shadow(0 0 24px rgba(99,102,241,.55))}
  }
  .app-title{font-size:22px; font-weight:900; letter-spacing:.3px; margin:2px 0 10px}
  .app-sub{color:var(--muted); font-size:14px; margin-bottom:18px}
  .login .status{
    display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
    font-weight:700; border:1px solid #263055; background:#0e1428; margin-bottom:10px;
  }
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.ok{background:var(--ok); box-shadow:0 0 10px var(--ok)}
  .dot.err{background:var(--err); box-shadow:0 0 10px var(--err)}
  .login .row{justify-content:center}
  .hidden{display:none}

  /* small helper texts */
  .note{font-size:12px;color:var(--muted)}
</style>
</head>
<body class="bg-anim">
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo-mini">S</div>
      <div>
        <div style="font-weight:900;letter-spacing:.3px">Olahan Sehat</div>
        <div class="muted">Catat olahraga + peta GPS</div>
      </div>
    </div>
    <nav id="nav"></nav>
  </header>

  <main id="view"></main>
</div>

<!-- ===== LOGIN OVERLAY ===== -->
<section id="login" class="login">
  <div class="panel">
    <div class="logo-S"><div class="s-glyph">S</div></div>
    <div class="app-title">Olahraga Sehat</div>
    <div class="app-sub">Devoloper: Rio.co.id.Jaga kebugaranmu, pantau rute, simpan riwayat.
    cara aktifkan lokasi pencet titik tiga di crome pojok kanan atas lalu pencet setelan situs
    lalu pencet ke lokasi lalu aktifkan lokasi tersebut terus pilih opsi "Luaskan semua permintaan"</div>

    <div id="gpsStatus" class="status hidden">
      <span class="dot" id="gpsDot"></span><span id="gpsText">Memeriksa lokasi…</span>
    </div>

    <div class="row" style="margin:8px 0 6px">
      <button id="btnMasuk" class="btn primary">Masuk</button>
      <button id="btnCoba" class="btn ghost hidden">Coba lagi</button>
    </div>
    <div class="note">Izin lokasi diperlukan agar peta & jarak akurat.</div>
  </div>
</section>

<script>
/* ---------- Mini Router ---------- */
const routes = [
  {path:'#/', name:'Beranda'},
  {path:'#/lari', name:'Lari'},
  {path:'#/sepeda', name:'Sepeda'},
  {path:'#/renang', name:'Renang'},
  {path:'#/yoga', name:'Yoga'},
  {path:'#/futsal', name:'Futsal'},
  {path:'#/peta', name:'Peta'},
  {path:'#/riwayat', name:'Riwayat'}
];
const navEl = document.getElementById('nav');
routes.forEach(r=>{
  const a=document.createElement('a'); a.href=r.path; a.textContent=r.name; a.className='tab';
  navEl.appendChild(a);
});
function setActiveTab(){
  [...navEl.children].forEach(a=>a.classList.toggle('active', a.getAttribute('href')===location.hash||(!location.hash&&a.getAttribute('href')==='#/')));
}
addEventListener('hashchange', ()=>{render(); setActiveTab();});
addEventListener('load', ()=>{if(!location.hash) location.hash = '#/'; render(); setActiveTab();});

/* ---------- State ---------- */
const storeKey='aktivitas:riwayat:v1';
const state = {
  recording:false, type:null, watchId:null,
  points:[], distance:0, startedAt:null, paused:false,
  map:null, line:null, marker:null
};
const metersToKm = m => (m/1000);
const fmtKm = km => km.toFixed(2)+' km';
const fmtPace = (sec, km)=> km>0? (sec/km/60).toFixed(1)+' mnt/km' : '—';
const fmtDur = s => {const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), d=s%60; return [h,m,d].map(v=>String(v).padStart(2,'0')).join(':');};
function loadHistory(){ try{ return JSON.parse(localStorage.getItem(storeKey)||'[]'); }catch{ return []; } }
function saveHistory(arr){ localStorage.setItem(storeKey, JSON.stringify(arr)); }
/* Haversine */
function dist(a,b){ const R=6371000, t=d=>d*Math.PI/180;
  const dLat=t(b.lat-a.lat), dLon=t(b.lng-a.lng), lat1=t(a.lat), lat2=t(b.lat);
  const x=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(x));
}

/* ---------- App Pages ---------- */
const view = document.getElementById('view');

function pageHome(){
  const hist=loadHistory();
  const totalKm = hist.reduce((s,h)=>s+h.distanceKm,0);
  const totalSec= hist.reduce((s,h)=>s+h.durationSec,0);

  view.innerHTML = `
    <div class="grid">
      <section class="card">
        <h2 class="title">Ringkasan</h2>
        <p class="muted">Semua aktivitas tersimpan lokal di perangkat ini.</p>
        <div class="stat" style="margin-top:10px">
          <div class="pill">Total Jarak</div><div>${fmtKm(totalKm)}</div>
          <div class="pill">Total Durasi</div><div>${fmtDur(totalSec)}</div>
          <div class="pill">Jumlah Sesi</div><div>${hist.length}</div>
        </div>
      </section>
      <section class="card">
        <h2 class="title">Mulai cepat</h2>
        <div class="row">
          ${['lari','sepeda','renang','yoga','futsal'].map(t=>(
            `<a class="btn ghost" href="#/${t}">▶ ${t[0].toUpperCase()+t.slice(1)}</a>`
          )).join('')}
          <a class="btn primary" href="#/peta">📍 Peta</a>
        </div>
      </section>
    </div>
  `;
}

function pageActivity(typeLabel){
  const type = typeLabel.toLowerCase();
  view.innerHTML = `
    <section class="card">
      <h2 class="title">${typeLabel}</h2>
      <p class="muted">Tekan mulai untuk merekam GPS.</p>
      <div class="row" style="margin:10px 0">
        <button class="btn primary" id="startBtn">Mulai</button>
        <button class="btn ghost" id="pauseBtn" disabled>Jeda</button>
        <button class="btn danger" id="stopBtn" disabled>Selesai</button>
        <a class="btn ghost" href="#/peta">Buka Peta</a>
      </div>
      <div class="grid">
        <div class="card">
          <div class="stat">
            <div class="pill">Durasi</div><div id="dur">00:00:00</div>
            <div class="pill">Jarak</div><div id="dist">0.00 km</div>
            <div class="pill">Pace</div><div id="pace">—</div>
            <small id="gpsInfo" class="muted">GPS belum aktif.</small>
          </div>
        </div>
        <div class="card">
          <div id="map"></div>
        </div>
      </div>
    </section>
  `;

  setupMap();
  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const durEl    = document.getElementById('dur');
  const distEl   = document.getElementById('dist');
  const paceEl   = document.getElementById('pace');
  const gpsInfo  = document.getElementById('gpsInfo');
  let timer=null;

  startBtn.onclick = ()=>{
    if(state.recording && state.type!==type) { alert('Sesi lain masih berjalan.'); return; }
    if(!state.recording){
      state.recording=true; state.type=type; state.points=[]; state.distance=0; state.startedAt=Date.now(); state.paused=false;
      startBtn.disabled=true; pauseBtn.disabled=false; stopBtn.disabled=false;
      gpsInfo.textContent='Mengaktifkan GPS...';
      startWatch();
      timer=setInterval(()=>{
        const sec = Math.floor(((state.paused? state.pausedAt:Date.now())-state.startedAt)/1000);
        durEl.textContent = fmtDur(sec);
        distEl.textContent = fmtKm(metersToKm(state.distance));
        paceEl.textContent = fmtPace(sec, metersToKm(state.distance));
      },500);
    }else if(state.paused){
      state.paused=false; state.startedAt += (Date.now()-state.pausedAt);
      startWatch(); pauseBtn.textContent='Jeda';
    }
  };
  pauseBtn.onclick = ()=>{
    if(!state.recording) return;
    if(!state.paused){
      state.paused=true; state.pausedAt=Date.now(); pauseWatch(); pauseBtn.textContent='Lanjut';
      gpsInfo.textContent='Dijeda.';
    }else{
      state.paused=false; state.startedAt += (Date.now()-state.pausedAt);
      startWatch(); pauseBtn.textContent='Jeda'; gpsInfo.textContent='Merekam...';
    }
  };
  stopBtn.onclick = ()=>{
    if(!state.recording) return;
    clearInterval(timer); pauseWatch();
    const durationSec = Math.floor((Date.now()-state.startedAt)/1000);
    const distanceKm = metersToKm(state.distance);
    const item = {
      id:crypto.randomUUID(), type, startedAt:new Date(state.startedAt).toISOString(),
      endedAt:new Date().toISOString(), durationSec, distanceKm, points: state.points
    };
    const hist = loadHistory(); hist.unshift(item); saveHistory(hist);
    state.recording=false; state.type=null; state.points=[]; state.distance=0;
    alert('Tersimpan ke Riwayat ✔'); location.hash='#/riwayat';
  };

  function startWatch(){
    if(!navigator.geolocation){ gpsInfo.textContent='Perangkat tidak mendukung geolokasi.'; return; }
    if(state.watchId) return;
    state.watchId = navigator.geolocation.watchPosition(pos=>{
      const {latitude, longitude, accuracy} = pos.coords;
      const p = {lat:latitude, lng:longitude, t:Date.now(), acc:accuracy};
      gpsInfo.textContent = `Akurasi ±${Math.round(accuracy)} m`;
      if(state.points.length){
        const last = state.points[state.points.length-1];
        const d = dist(last,p);
        if(accuracy<=50 && d<100){ state.distance += d; }
      }
      state.points.push(p); updateMap(p);
    }, err=>{
      gpsInfo.textContent='GPS error: '+err.message;
    }, {enableHighAccuracy:true, maximumAge:0, timeout:15000});
  }
  function pauseWatch(){
    if(state.watchId){ navigator.geolocation.clearWatch(state.watchId); state.watchId=null; }
  }
}

function pageMap(){
  view.innerHTML = `
    <section class="card">
      <h2 class="title">Peta Aktivitas</h2>
      <p class="muted">Titik biru: posisi saat ini. Garis: rute sesi yang sedang direkam.</p>
      <div id="map"></div>
      <div class="row" style="margin-top:10px">
        <a class="btn ghost" href="#/riwayat">Buka Riwayat</a>
        <button class="btn primary" id="gotoMe">Center ke Saya</button>
      </div>
    </section>
  `;
  setupMap();
  document.getElementById('gotoMe').onclick = ()=> {
    if(state.points.length){ state.map.setView(state.points[state.points.length-1], 16); }
  };
}

function pageHistory(){
  const hist=loadHistory();
  view.innerHTML = `
    <section class="card">
      <h2 class="title">Riwayat Aktivitas</h2>
      <p class="muted">Data disimpan lokal di perangkat ini.</p>
      <div class="row" style="margin:8px 0">
        <button class="btn danger" id="clearAll">Hapus Semua</button>
      </div>
      <div class="card" style="overflow:auto">
        <table>
          <thead><tr><th>Jenis</th><th>Mulai</th><th>Durasi</th><th class="right">Jarak</th><th>Aksi</th></tr></thead>
          <tbody id="tbody">${hist.map(renderRow).join('')}</tbody>
        </table>
      </div>
    </section>
  `;
  document.getElementById('clearAll').onclick=()=>{
    if(confirm('Hapus semua riwayat?')){ saveHistory([]); pageHistory(); }
  };
  document.querySelectorAll('[data-del]').forEach(btn=>{
    btn.onclick=()=>{
      const id=btn.getAttribute('data-del');
      const arr=loadHistory().filter(x=>x.id!==id); saveHistory(arr); pageHistory();
    };
  });
  document.querySelectorAll('[data-view]').forEach(btn=>{
    btn.onclick=()=>{
      const id=btn.getAttribute('data-view');
      const item=loadHistory().find(x=>x.id===id);
      showHistoryMap(item);
    };
  });
  function renderRow(h){
    const start=new Date(h.startedAt);
    return `<tr>
      <td style="text-transform:capitalize">${h.type}</td>
      <td>${start.toLocaleString()}</td>
      <td>${fmtDur(h.durationSec)}</td>
      <td class="right">${fmtKm(h.distanceKm)}</td>
      <td>
        <button class="btn ghost" data-view="${h.id}">Peta</button>
        <button class="btn danger" data-del="${h.id}">Hapus</button>
      </td>
    </tr>`;
  }
}
function showHistoryMap(item){
  view.innerHTML = `
    <section class="card">
      <h2 class="title" style="text-transform:capitalize">${item.type} — Peta Riwayat</h2>
      <div class="pill" style="display:inline-block;margin-bottom:8px">
        ${new Date(item.startedAt).toLocaleString()} • ${fmtDur(item.durationSec)} • ${fmtKm(item.distanceKm)}
      </div>
      <div id="map"></div>
      <div class="row" style="margin-top:10px">
        <a class="btn ghost" href="#/riwayat">Kembali</a>
      </div>
    </section>
  `;
  setupMap();
  if(item.points?.length){
    const latlngs = item.points.map(p=>[p.lat,p.lng]);
    state.line.setLatLngs(latlngs);
    state.map.fitBounds(L.latLngBounds(latlngs), {padding:[20,20]});
  }
}

/* ---------- Map Helpers ---------- */
function setupMap(){
  const mapEl=document.getElementById('map'); if(!mapEl) return;
  if(state.map){ state.map.remove(); state.map=null; }
  state.map = L.map(mapEl, {zoomControl:true});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(state.map);
  state.line = L.polyline([], {weight:5}).addTo(state.map);
  state.marker = L.circleMarker([0,0], {radius:7, weight:2}).addTo(state.map);

  if(state.points.length){
    state.map.setView(state.points[state.points.length-1], 16);
    state.line.setLatLngs(state.points.map(p=>[p.lat,p.lng]));
    state.marker.setLatLng(state.points[state.points.length-1]);
  }else{
    state.map.setView([-6.2,106.8], 11);
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(p=>{
        state.map.setView([p.coords.latitude,p.coords.longitude], 15);
      });
    }
  }
}
function updateMap(p){
  if(!state.map) return;
  const latlng=[p.lat,p.lng];
  const arr = state.line.getLatLngs(); arr.push(latlng); state.line.setLatLngs(arr);
  state.marker.setLatLng(latlng);
  if(arr.length===1){ state.map.setView(latlng, 16); }
}

/* ---------- LOGIN + GPS DETECTOR ---------- */
const loginEl = document.getElementById('login');
const gpsStatus = document.getElementById('gpsStatus');
const gpsDot = document.getElementById('gpsDot');
const gpsText = document.getElementById('gpsText');
const btnMasuk = document.getElementById('btnMasuk');
const btnCoba  = document.getElementById('btnCoba');

btnMasuk.addEventListener('click', async ()=>{
  gpsStatus.classList.remove('hidden');
  gpsDot.className='dot'; gpsText.textContent='Memeriksa lokasi…';
  btnMasuk.disabled=true;

  if(!('geolocation' in navigator)){
    setErr('Perangkat tidak mendukung geolokasi.');
    return;
  }
  try{
    const pos = await getPosition({enableHighAccuracy:true, maximumAge:0, timeout:10000});
    setOk(`Lokasi aktif (${pos.coords.latitude.toFixed(4)}, ${pos.coords.longitude.toFixed(4)})`);
    // Pindah ke aplikasi setelah sedikit delay biar transisi terlihat
    setTimeout(()=>{ loginEl.classList.add('hidden'); }, 600);
  }catch(e){
    setErr('Lokasi belum aktif. Izinkan akses GPS lalu coba lagi.');
  }
});

btnCoba.addEventListener('click', ()=> btnMasuk.click());

function setOk(msg){ gpsDot.className='dot ok'; gpsText.textContent=msg; btnCoba.classList.add('hidden'); }
function setErr(msg){ gpsDot.className='dot err'; gpsText.textContent=msg; btnCoba.classList.remove('hidden'); btnMasuk.disabled=false; }

function getPosition(opts){
  return new Promise((res,rej)=>{
    navigator.geolocation.getCurrentPosition(res, rej, opts);
  });
}

/* ---------- Initial Render ---------- */
function render(){
  switch(location.hash){
    case '#/': pageHome(); break;
    case '#/lari': pageActivity('Lari'); break;
    case '#/sepeda': pageActivity('Sepeda'); break;
    case '#/renang': pageActivity('Renang'); break;
    case '#/yoga': pageActivity('Yoga'); break;
    case '#/futsal': pageActivity('Futsal'); break;
    case '#/peta': pageMap(); break;
    case '#/riwayat': pageHistory(); break;
    default: location.hash = '#/';
  }
}
</script>
</body>
</html>
